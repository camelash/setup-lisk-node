- name: Copy dump_snapshot.sh/restore_snapshot.sh
  copy:
    src: "blockchain/{{item}}"
    dest: /workspace
    mode: 0700
  with_items:
  - dump_snapshot.sh
  - restore_snapshot.sh

- name: Directory 'snapshots' created
  file:
    path=/workspace/snapshots
    state=directory

- name: Blockchain snapshot downloaded
  get_url:
    url: http://lisk.prolina.org/snapshots/lisk_test_h4931992_2018-04-12T08-21-54Z.pg_dump_dump
    checksum: "sha256:89e0fbb2ede5ade7da0030ed66c6288ef8a581a64caff0d32f105ce96fd9b401"
    dest: /workspace/snapshots/lisk_test_snapshot.pg_dump_dump
    # use tmp_dest to work around https://github.com/ansible/ansible/issues/18894
    tmp_dest: /tmp

- name: Restore from snapshot
  shell: ./restore_snapshot.sh /workspace/snapshots/lisk_test_snapshot.pg_dump_dump && touch /workspace/snapshots/restored.yes
  args:
    chdir: /workspace
    creates: /workspace/snapshots/restored.yes
